<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<title data-react-helmet="true">Key Migration | IBM Operator for Redis Cluster</title><meta data-react-helmet="true" property="og:url" content="https://ibm.github.io/operator-for-redis-cluster/key-migration"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Key Migration | IBM Operator for Redis Cluster"><meta data-react-helmet="true" name="description" content="Overview"><meta data-react-helmet="true" property="og:description" content="Overview"><link data-react-helmet="true" rel="shortcut icon" href="/operator-for-redis-cluster/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://ibm.github.io/operator-for-redis-cluster/key-migration"><link data-react-helmet="true" rel="alternate" href="https://ibm.github.io/operator-for-redis-cluster/key-migration" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://ibm.github.io/operator-for-redis-cluster/key-migration" hreflang="x-default"><link rel="stylesheet" href="/operator-for-redis-cluster/assets/css/styles.99f68936.css">
<link rel="preload" href="/operator-for-redis-cluster/assets/js/runtime~main.73d3be94.js" as="script">
<link rel="preload" href="/operator-for-redis-cluster/assets/js/main.701b046a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/operator-for-redis-cluster/"><img src="/operator-for-redis-cluster/images/logo.svg" alt="ICM Redis Operator" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/operator-for-redis-cluster/images/logo.svg" alt="ICM Redis Operator" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">ICM Redis Operator</b></a></div><div class="navbar__items navbar__items--right"><a href="https://ibm.github.io/operator-for-redis-cluster" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_2i4l react-toggle--checked react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_lDyR"><button class="clean-btn backToTopButton_i9tI" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/operator-for-redis-cluster/">Home</a></li><li class="menu__list-item"><a class="menu__link" href="/operator-for-redis-cluster/cookbook">Cookbook</a></li><li class="menu__list-item"><a class="menu__link" href="/operator-for-redis-cluster/kubectl-plugin">Kubectl Plugin</a></li><li class="menu__list-item"><a class="menu__link" href="/operator-for-redis-cluster/configuration">Redis Server Configuration</a></li><li class="menu__list-item"><a class="menu__link" href="/operator-for-redis-cluster/scaling">Scaling Operations</a></li><li class="menu__list-item"><a class="menu__link" href="/operator-for-redis-cluster/rolling-update">Rolling Update Procedure</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" href="/operator-for-redis-cluster/key-migration">Key Migration</a></li><li class="menu__list-item"><a class="menu__link" href="/operator-for-redis-cluster/contributing">Contributing</a></li><li class="menu__list-item"><a class="menu__link" href="/operator-for-redis-cluster/code-of-conduct">Code of Conduct</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_eoK2"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_e+kA"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_dC7a">Key Migration</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="overview"></a>Overview<a class="hash-link" href="#overview" title="Direct link to heading">#</a></h2><p>Key migration is the process by which Redis migrates keys from a source primary node to a destination primary node. The high-level steps for migrating keys can be found <a href="https://redis.io/commands/cluster-setslot#redis-cluster-live-resharding-explained" target="_blank" rel="noopener noreferrer">here</a>. This feature allows users to better configure how keys are migrated, if at all.</p><p>Depending on the size of the Redis cluster, the key migration process can be time-consuming. For example, a cluster with thousands of Gigabytes of data can take hours to migrate keys during a scaling or rolling update operation. To speed up the scaling process, we give users the option to migrate slots without keys and provide configuration to control batching.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="redis-cluster-migration-configuration"></a>Redis cluster migration configuration<a class="hash-link" href="#redis-cluster-migration-configuration" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="default"></a>Default<a class="hash-link" href="#default" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">rollingUpdate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyMigration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slotBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">idleTimeoutMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">30000</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">warmingDelayMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">scaling</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slotBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">idleTimeoutMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">30000</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If you observe the default configuration above, you will notice that there are two separate sections for configuring key migration during rolling updates and scaling operations. The <code>rollingUpdate</code> section determines how keys are migrated during <a href="/operator-for-redis-cluster/rolling-update">rolling updates</a>, and the <code>scaling</code> section determines how keys are migrated during <a href="/operator-for-redis-cluster/scaling">scaling operations</a>. The following definitions apply to both configurations.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="definitions"></a>Definitions<a class="hash-link" href="#definitions" title="Direct link to heading">#</a></h3><p><code>keyMigration</code> specifies whether to migrate keys during rolling updates. For most use cases, users will want to keep this value set to <code>true</code>. However, for users who use Redis cluster as a caching tool instead of a persistent database, you may want to consider setting this to <code>false</code>. When set to <code>false</code>, this feature will transfer slots from the old Redis primary to the new primary without migrating keys. For large clusters, this can save a significant amount of time with the tradeoff of temporarily increasing the number of requests to the backend. The increase in backend hit rate can be mitigated by modifying <code>warmingDelayMillis</code>. The next sections will discuss the two different configuration options for key migration.</p><p><code>keyBatchSize</code> determines the number of keys to get from a single slot during each migration iteration. By default, this value is <code>10000</code> keys.</p><p><code>slotBatchSize</code> specifies the number of slots to migrate on each iteration. By default, this value is <code>16</code> slots. For most use cases, set this value to the number of logical CPUs. Usually, this is two times the CPU resource limits in the Redis operator deployment. See <a href="https://pkg.go.dev/runtime#NumCPU" target="_blank" rel="noopener noreferrer">runtime.CPU</a> for more information on how Go checks the number of available CPUs. Also, keep in mind a Redis cluster has <code>16384</code> total slots, and those slots are evenly distributed across the primary nodes.</p><p><code>idleTimeoutMillis</code> is the maximum idle time at any point during key migration. This means the migration should make progress without blocking for more than the specified number of milliseconds. See the <a href="https://redis.io/commands/migrate" target="_blank" rel="noopener noreferrer">Redis migrate command</a> for more information about the timeout.</p><p><code>warmingDelayMillis</code> is the amount of time in between each batch of slots. As the name suggests, it allows the new Redis node to warm its cache before moving on to the next node in the rolling update.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="rolling-update-key-migration-enabled---rollingupdatekeymigration-true"></a>Rolling update key migration enabled - <code>rollingUpdate.keyMigration: true</code><a class="hash-link" href="#rolling-update-key-migration-enabled---rollingupdatekeymigration-true" title="Direct link to heading">#</a></h3><p><code>keyBatchSize</code>: change this value depending on the total number of keys in your Redis cluster. Increasing this value can reduce the amount of time it takes to migrate keys by moving a larger number of keys per batch of slots.</p><p><code>slotBatchSize</code>: increasing this value higher than the number of logical CPUs will have minimal effect on rolling update performance.</p><p><code>idleTimeoutMillis</code>: do not modify this value unless you receive this specific error.</p><p><code>warmingDelayMillis</code>: it&#x27;s best to set this value to zero unless you want to introduce a delay between slot migrations. You can still set a non-zero delay if you want to reduce the overall strain on the cluster by the migration calls, and you do not care about how long the migration takes.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="examples"></a>Examples<a class="hash-link" href="#examples" title="Direct link to heading">#</a></h4><p>Assume all clusters have allocated 4 physical CPUs and 1 Gb memory for the Redis operator. We have 8 logical CPUs.</p><p>Given a small redis cluster with 3 primaries, RF = 1, and maximum memory of 1 Gb per node - we have the following configuration:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">rollingUpdate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># For rolling updates,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyMigration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain">          </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Key migration is enabled</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token plain">          </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Migrate keys in batches of 1,000 per slot </span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slotBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Transfer 8 slots on each migration iteration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">idleTimeoutMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">30000</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Wait up to 30 seconds for any delay in communication during the migration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">warmingDelayMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">       </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># No delay between each batch of 2,500 slots</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">scaling</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># For scaling operations,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token plain">          </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Migrate keys in batches of 1,000 per slot</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slotBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Transfer 8 slots on each migration iteration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">idleTimeoutMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">30000</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Wait up to 30 seconds for any delay in communication during the migration</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Given a large redis cluster with 20 primaries, RF = 1, and maximum memory of 10 Gb per node:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">rollingUpdate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># For rolling updates,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyMigration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain">          </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Key migration is enabled</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token plain">         </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Migrate keys in batches of 10,000 per slot</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slotBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Transfer 8 slots on each migration iteration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">idleTimeoutMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">30000</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Wait up to 30 seconds for any delay in communication during the migration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">warmingDelayMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">       </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># No delay between each batch of slots</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">scaling</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># For scaling operations,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token plain">         </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Migrate keys in batches of 10,000 per slot</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slotBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Transfer 8 slots on each migration iteration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">idleTimeoutMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">30000</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Wait up to 30 seconds for any delay in communication during the migration</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Observe how <code>keyBatchSize</code> is significantly greater than in the previous example because we have ten times the data per node.</p><p>Here we have a cluster with 10 primaries, RF = 1, and maximum memory of 5Gb per node. We optimize for fast key migration on both rolling updates and scaling operations:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">rollingUpdate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># For rolling updates,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyMigration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain">          </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Key migration is enabled</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">50000</span><span class="token plain">         </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Migrate keys in batches of 50,000 per slot</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slotBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Transfer 8 slots on each migration iteration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">idleTimeoutMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">30000</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Wait up to 30 seconds for any delay in communication during the migration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">warmingDelayMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">       </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># No delay between each batch of slots</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">scaling</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># For scaling operations,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">50000</span><span class="token plain">         </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Migrate keys in batches of 50,000 per slot</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slotBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Transfer 8 slots on each migration iteration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">idleTimeoutMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">30000</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Wait up to 30 seconds for any delay in communication during the migration</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="rolling-update-key-migration-disabled---rollingupdatekeymigration-false"></a>Rolling update key migration disabled - <code>rollingUpdate.keyMigration: false</code><a class="hash-link" href="#rolling-update-key-migration-disabled---rollingupdatekeymigration-false" title="Direct link to heading">#</a></h3><p><code>keyBatchSize</code>: not used when no keys are migrated.</p><p><code>slotBatchSize</code>: depends on how quickly you want to wipe the cache. You can use a smaller <code>slotBatchSize</code> and increase <code>warmingDelayMillis</code> to make this process go slower. If your backend can handle a higher increase in requests, you can set <code>warmingDelayMillis</code> to something small or even zero.</p><p><code>idleTimeoutMillis</code>: not used in when no keys are migrated.</p><p><code>warmingDelayMillis</code>: increasing this value will ease the strain on your backend as slot ownership transfers during a rolling update by pausing after migrating a single batch of slots. </p><p>Please be sure to properly configure <code>rollingUpdate</code> based on your Redis cluster if you plan on using this configuration. Setting too small a value for <code>warmingDelayMillis</code> will quickly wipe all the keys in your cluster without yielding sufficient time for new Redis nodes to warm up.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="examples-1"></a>Examples<a class="hash-link" href="#examples-1" title="Direct link to heading">#</a></h4><p>Given a small redis cluster with 3 primaries, RF = 1, and maximum memory of 1 Gb per node - we have the following configuration:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">rollingUpdate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># For rolling updates,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyMigration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain">         </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Key migration is disabled</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slotBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Transfer 8 slots on each migration iteration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">warmingDelayMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Wait 1 second between each batch of slots</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">scaling</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># For scaling operations,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token plain">         </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Migrate keys in batches of 10,000 per slot</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slotBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Transfer 8 slots on each migration iteration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">idleTimeoutMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">30000</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Wait up to 30 seconds for any delay in communication during the migration</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Given a large redis cluster with 20 primaries, RF = 1, and maximum memory of 10 Gb per node:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">rollingUpdate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># For rolling updates,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyMigration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain">         </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Key migration is disabled</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slotBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Transfer 8 slots on each migration iteration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">warmingDelayMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token plain">   </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Wait 10 seconds between each batch of slots</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">scaling</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># For scaling operations,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token plain">         </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Migrate keys in batches of 10,000 per slot</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slotBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Transfer 8 slots on each migration iteration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">idleTimeoutMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">30000</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Wait up to 30 seconds for any delay in communication during the migration</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here we have a cluster with 10 primaries, RF = 1, and maximum memory of 5Gb per node. We want to wipe the cache as quickly as possible on rolling updates, while also maintaining fast key migration on scaling operations:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">rollingUpdate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># For rolling updates,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyMigration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain">         </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Key migration is disabled</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slotBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Transfer 8 slots on each migration iteration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">warmingDelayMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">       </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># No delay between each batch of slots</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">scaling</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">                      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># For scaling operations,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">keyBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">50000</span><span class="token plain">         </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Migrate keys in batches of 50,000 per slot</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">slotBatchSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Transfer 8 slots on each migration iteration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">idleTimeoutMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">30000</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Wait up to 30 seconds for any delay in communication during the migration</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://ibm.github.io/operator-for-redis-cluster/docs/key-migration.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_wj+Z">Last updated on <b><time datetime="2022-01-06T22:04:30.000Z">1/6/2022</time></b></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/operator-for-redis-cluster/rolling-update"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Rolling Update Procedure</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/operator-for-redis-cluster/contributing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Contributing Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link">Overview</a></li><li><a href="#redis-cluster-migration-configuration" class="table-of-contents__link">Redis cluster migration configuration</a><ul><li><a href="#default" class="table-of-contents__link">Default</a></li><li><a href="#definitions" class="table-of-contents__link">Definitions</a></li><li><a href="#rolling-update-key-migration-enabled---rollingupdatekeymigration-true" class="table-of-contents__link">Rolling update key migration enabled - <code>rollingUpdate.keyMigration: true</code></a></li><li><a href="#rolling-update-key-migration-disabled---rollingupdatekeymigration-false" class="table-of-contents__link">Rolling update key migration disabled - <code>rollingUpdate.keyMigration: false</code></a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">IBM Operator for Redis Cluster Documentation. Built with Docusaurus.</div></div></div></footer></div>
<script src="/operator-for-redis-cluster/assets/js/runtime~main.73d3be94.js"></script>
<script src="/operator-for-redis-cluster/assets/js/main.701b046a.js"></script>
</body>
</html>